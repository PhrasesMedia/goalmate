<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Goal Trophies - Cloud Sync</title>
  <meta name="description" content="A personal goal trophy system with cloud sync via Firebase." />
  <style>
    :root{
      --bg0:#070b12;
      --bg1:#0a1322;
      --text:#eaf0ff;
      --muted:#b7c6ea;
      --muted2:#92a4cf;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --shadow: 0 18px 55px rgba(0,0,0,.50);
      --accent: rgba(140,200,255,.55);
      --accent2: rgba(255,210,120,.55);
      --good: rgba(125,255,205,.65);
      --warn: rgba(255,185,110,.70);
      --bad: rgba(255,120,140,.70);

      --brz:#c9855a;
      --sil:#c9d4ea;
      --gol:#ffd36e;
      --pla:#a78bff;

      --r: 16px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(140,200,255,.10), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(255,210,120,.10), transparent 55%),
        radial-gradient(1000px 800px at 60% 100%, rgba(167,139,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{color:inherit}
    button, input, select, textarea {font-family: inherit}

    /* Login/Auth Screen Styles */
    #authScreen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .authBox {
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 40px 32px;
      max-width: 420px;
      width: 100%;
    }

    .authLogo {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      border-radius: 16px;
      background:
        radial-gradient(22px 22px at 30% 30%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(28px 28px at 70% 70%, rgba(0,0,0,.35), transparent 62%),
        linear-gradient(135deg, rgba(140,200,255,.55), rgba(255,210,120,.40));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
    }

    .authTitle {
      text-align: center;
      font-size: 24px;
      margin: 0 0 8px;
    }

    .authSubtitle {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin: 0 0 30px;
    }

    .authForm {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .authError {
      padding: 12px;
      background: rgba(255,120,140,.15);
      border: 1px solid rgba(255,120,140,.35);
      border-radius: 12px;
      color: var(--bad);
      font-size: 13px;
      display: none;
    }

    .authError.show {
      display: block;
    }

    .authSuccess {
      padding: 12px;
      background: rgba(125,255,205,.15);
      border: 1px solid rgba(125,255,205,.35);
      border-radius: 12px;
      color: var(--good);
      font-size: 13px;
      display: none;
    }

    .authSuccess.show {
      display: block;
    }

    .authToggle {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: var(--muted);
    }

    .authToggle button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }

    /* Main App Styles */
    #appScreen {
      display: none;
    }

    #appScreen.show {
      display: block;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px 64px}
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin:10px 0 14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width: 260px;}
    .logo{
      width:44px; height:44px; border-radius:12px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(24px 24px at 70% 70%, rgba(0,0,0,.35), transparent 62%),
        linear-gradient(135deg, rgba(140,200,255,.55), rgba(255,210,120,.40));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    h1{font-size:18px; margin:0}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .topActions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .pill strong{color:var(--text); font-weight:700}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      border-color: rgba(140,200,255,.35);
      background: linear-gradient(180deg, rgba(140,200,255,.14), rgba(140,200,255,.05));
    }
    .btn.warn{
      border-color: rgba(255,185,110,.35);
      background: linear-gradient(180deg, rgba(255,185,110,.14), rgba(255,185,110,.05));
    }
    .btn.danger{
      border-color: rgba(255,120,140,.35);
      background: linear-gradient(180deg, rgba(255,120,140,.14), rgba(255,120,140,.05));
    }
    .btn.ghost{
      border-color: rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .brand{min-width:auto}
      .topActions{justify-content:flex-start}
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .cardHead h2{margin:0; font-size:14px; letter-spacing: .2px;}
    .hint{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.25}
    .cardBody{padding:12px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > * {flex: 1 1 auto}

    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 160px;
    }
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder{color: rgba(183,198,234,.55)}
    .small{font-size:12px; color:var(--muted)}
    .sep{height:1px; background: rgba(255,255,255,.08); margin:12px 0}

    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      background: rgba(0,0,0,.18);
    }

    .trophyMeta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      justify-content:flex-end;
      color: var(--muted);
      font-size:12px;
    }

    .trophyList{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 700px){
      .trophyList{grid-template-columns: 1fr}
    }

    .trophy{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      position:relative;
      overflow:hidden;
    }
    .trophy::before{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:120px; height:120px;
      transform: rotate(25deg);
      background: radial-gradient(closest-side, rgba(255,255,255,.10), transparent 70%);
      pointer-events:none;
      opacity:.6;
    }

    .icon{
      width:42px; height:42px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.18), transparent 65%),
        radial-gradient(20px 20px at 70% 70%, rgba(0,0,0,.35), transparent 62%),
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      display:flex; align-items:center; justify-content:center;
      flex: 0 0 auto;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .trophyImg{
      width:30px;
      height:30px;
      object-fit:contain;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.45));
      pointer-events:none;
      user-select:none;
    }

    .toggle{display:flex; align-items:center; gap:8px; user-select:none;}
    .check{
      width:42px; height:26px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      position:relative; cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .check.on{
      background: linear-gradient(90deg, rgba(125,255,205,.25), rgba(125,255,205,.15));
      border-color: rgba(125,255,205,.40);
    }
    .knob{
      width:18px; height:18px; border-radius:999px;
      position:absolute; top:3px; left:3px;
      background: linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.18));
      border:1px solid rgba(255,255,255,.25);
      transition: transform .15s ease, background .15s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.35);
    }
    .check.on .knob{
      transform: translateX(16px);
      background: linear-gradient(135deg, rgba(125,255,205,.85), rgba(125,255,205,.60));
      border-color: rgba(125,255,205,.55);
    }

    .tMain{flex:1; min-width:0}
    .tTitle{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      font-weight:600; font-size:14px; margin-bottom:4px;
    }
    .tDesc{font-size:13px; color:var(--muted); line-height:1.35; margin-bottom:8px}
    .tFoot{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
    .tTags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{
      font-size:10px; padding:2px 7px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18); color:var(--muted);
    }
    .tag.auto{border-color: rgba(140,200,255,.35); color:var(--accent)}
    .tag.hidden{border-color: rgba(255,185,110,.35); color:var(--warn)}
    .tag.manual{border-color: rgba(125,255,205,.35); color:var(--good)}
    .tag.date{border-color: rgba(255,255,255,.08); color:var(--muted2)}

    .trophy.locked{opacity:.65}
    .trophy.locked .icon{opacity:.8}
    .hiddenMask{position:relative}

    .goalGame{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .goalGameHead{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      gap:10px;
      align-items:center;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.04));
      border-bottom:1px solid rgba(255,255,255,.08);
      transition: background .12s ease;
    }
    .goalGameHead:hover{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02))}

    .goalGameLeft{display:flex; gap:10px; align-items:center}
    .goalGameArt{
      width:48px; height:48px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(16px 16px at 30% 30%, rgba(255,255,255,.18), transparent 65%),
        radial-gradient(22px 22px at 70% 70%, rgba(0,0,0,.35), transparent 62%),
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      box-shadow: 0 8px 22px rgba(0,0,0,.30);
    }
    .goalGameArt img{width:32px; height:32px; object-fit:contain}
    .goalGameMeta{min-width:0}
    .goalGameName{font-weight:600; font-size:15px}
    .goalGameHint{color:var(--muted); font-size:12px; margin-top:2px}

    .goalCount{
      width:36px; height:36px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:700;
    }
    .goalCount.b{border-color:var(--brz); color:var(--brz)}
    .goalCount.s{border-color:var(--sil); color:var(--sil)}
    .goalCount.g{border-color:var(--gol); color:var(--gol)}
    .goalCount.p{border-color:var(--pla); color:var(--pla)}

    .goalPct{display:flex; flex-direction:column; gap:4px; min-width:70px}
    .goalMiniBar{height:6px; background:rgba(0,0,0,.20); border-radius:999px; overflow:hidden}
    .goalMiniFill{height:100%; background:linear-gradient(90deg, rgba(140,200,255,.60), rgba(125,255,205,.60)); border-radius:999px; transition: width .25s ease}

    .goalGame.open .goalGameBody{display:block}
    .goalGameBody{
      padding:12px;
      display:none;
    }

    @media (max-width: 800px){
      .goalGameHead{
        grid-template-columns: 1fr auto auto;
        gap:8px;
      }
      .goalCount{display:none}
    }

    .overlay{
      position:fixed; inset:0; z-index:999;
      background: rgba(7,11,18,.75);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center; justify-content:center;
      padding:20px;
      animation: fadeIn .18s ease;
    }
    .overlay.show{display:flex}
    @keyframes fadeIn{from{opacity:0} to{opacity:1}}

    .modal{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius:20px;
      box-shadow: 0 30px 90px rgba(0,0,0,.70);
      width:100%; max-width:700px;
      max-height:90vh;
      overflow:auto;
      animation: slideUp .22s ease;
    }
    @keyframes slideUp{from{transform:translateY(30px); opacity:0} to{transform:translateY(0); opacity:1}}

    .modalHead{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modalHead h2{margin:0; font-size:16px}
    .closeBtn{
      width:32px; height:32px; border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; line-height:1;
      transition: background .12s ease, border-color .12s ease;
    }
    .closeBtn:hover{background: rgba(0,0,0,.30); border-color: rgba(255,255,255,.22)}

    .modalBody{padding:18px}
    .modalSection{margin-bottom:20px}
    .modalSection:last-child{margin-bottom:0}

    .warn-box{
      background: rgba(255,185,110,.10);
      border:1px solid rgba(255,185,110,.30);
      border-radius:12px;
      padding:12px;
      font-size:13px;
      color:var(--warn);
      margin-top:12px;
      display:none;
    }
    .warn-box.show{display:block}

    .syncStatus {
      font-size: 11px;
      color: var(--muted2);
    }
    .syncStatus.syncing {
      color: var(--accent);
    }
    .syncStatus.error {
      color: var(--bad);
    }
  </style>
</head>
<body>

<!-- Auth Screen (Login/Signup) -->
<div id="authScreen">
  <div class="authBox">
    <div class="authLogo"></div>
    <h2 class="authTitle">Goal Trophies</h2>
    <p class="authSubtitle">Track your achievements across all devices</p>

    <div class="authError" id="authError"></div>
    <div class="authSuccess" id="authSuccess"></div>

    <div id="loginForm" class="authForm">
      <div class="field">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="your@email.com" />
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn primary" id="loginBtn">Log In</button>
    </div>

    <div id="signupForm" class="authForm" style="display:none;">
      <div class="field">
        <label>Email</label>
        <input type="email" id="signupEmail" placeholder="your@email.com" />
      </div>
      <div class="field">
        <label>Password (min 6 characters)</label>
        <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <button class="btn primary" id="signupBtn">Create Account</button>
    </div>

    <div class="authToggle">
      <span id="toggleText">Don't have an account?</span>
      <button id="toggleAuth">Sign up</button>
    </div>
  </div>
</div>

<!-- Main App Screen -->
<div id="appScreen">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Goal Trophies</h1>
          <div class="sub">Track your achievements ‚Ä¢ <span id="userEmail"></span></div>
        </div>
      </div>
      <div class="topActions">
        <div class="pill">
          <span class="syncStatus" id="syncStatus">Synced</span>
        </div>
        <button class="btn primary" id="btnManage">‚öôÔ∏è Manage Goals</button>
        <button class="btn ghost" id="logoutBtn">Log Out</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="cardHead">
          <div>
            <h2>üìä Quick Actions</h2>
            <div class="hint">Log actions to automatically unlock trophies</div>
          </div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label>Action Type</label>
              <select id="actionType">
                <option value="">No auto-unlock types yet</option>
              </select>
            </div>
            <div class="field">
              <label>Count</label>
              <input type="number" id="actionCount" value="1" min="1" />
            </div>
            <button class="btn primary" id="btnLog" style="margin-top:auto">Log Action</button>
          </div>
        </div>
      </div>
    </div>

    <div id="goalTable"></div>
  </div>
</div>

<!-- Manage Modal -->
<div class="overlay" id="manageOverlay">
  <div class="modal">
    <div class="modalHead">
      <h2>‚öôÔ∏è Manage Goals & Trophies</h2>
      <button class="closeBtn" id="mgClose">√ó</button>
    </div>
    <div class="modalBody">
      <div class="modalSection">
        <h3 style="margin:0 0 10px; font-size:14px">‚ûï Add New Goal</h3>
        <div class="row">
          <div class="field">
            <label>Goal Title</label>
            <input type="text" id="mgGoalTitle" placeholder="e.g., Learning Spanish" />
          </div>
          <div class="field">
            <label>Description (optional)</label>
            <input type="text" id="mgGoalHint" placeholder="e.g., Daily practice goals" />
          </div>
        </div>
        <button class="btn primary" id="mgAddGoal" style="margin-top:10px">Add Goal</button>
      </div>

      <div class="sep"></div>

      <div class="modalSection">
        <h3 style="margin:0 0 10px; font-size:14px">‚úèÔ∏è Edit Goal</h3>
        <div class="field">
          <label>Select Goal</label>
          <select id="mgSelectGoal"></select>
        </div>
        <div id="mgEditBox" style="margin-top:14px; display:none">
          <div class="row">
            <div class="field">
              <label>Goal Title</label>
              <input type="text" id="mgEditTitle" />
            </div>
            <div class="field">
              <label>Description</label>
              <input type="text" id="mgEditHint" />
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn primary" id="mgSaveGoalEdits">Save Changes</button>
            <button class="btn danger" id="mgDeleteGoal">Delete Goal</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="modalSection">
        <h3 style="margin:0 0 10px; font-size:14px">üèÜ Add Trophy</h3>
        <div class="small" style="margin-bottom:10px">Trophy will be added to the selected goal above.</div>
        <div class="row">
          <div class="field">
            <label>Trophy Title</label>
            <input type="text" id="mgTrophyTitle" placeholder="e.g., First Week Complete" />
          </div>
          <div class="field">
            <label>Description</label>
            <input type="text" id="mgTrophyDesc" placeholder="e.g., 7 days in a row" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Tier</label>
            <select id="mgTrophyTier">
              <option value="bronze">Bronze</option>
              <option value="silver">Silver</option>
              <option value="gold">Gold</option>
              <option value="platinum">Platinum</option>
            </select>
          </div>
          <div class="field">
            <label>Hidden?</label>
            <select id="mgTrophyHidden">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label style="display:block; margin-bottom:8px">Auto-unlock rule (optional):</label>
          <div class="row">
            <div class="field">
              <label>Action Type</label>
              <input type="text" id="mgRuleType" placeholder="e.g., study_session" />
            </div>
            <div class="field">
              <label>Threshold</label>
              <input type="number" id="mgRuleThresh" value="1" min="1" />
            </div>
          </div>
          <div class="small" style="margin-top:6px">Leave action type blank for manual-only trophies.</div>
        </div>
        <button class="btn primary" id="mgAddTrophy" style="margin-top:10px">Add Trophy</button>

        <div class="warn-box" id="platWarning">
          ‚ö†Ô∏è Platinum trophies auto-unlock when all other trophies in the goal are unlocked. You don't need an auto-unlock rule for Platinum.
        </div>
      </div>

      <div class="sep"></div>

      <div class="modalSection">
        <h3 style="margin:0 0 10px; font-size:14px">üìã Trophy List</h3>
        <div class="small" style="margin-bottom:10px">Trophies for the selected goal. Click to edit or delete.</div>
        <div id="mgTrophyList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged 
  } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    onSnapshot 
  } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

  // üî• FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDhnxkWMz_72DFqberPkopln1ncvOgUoNc",
    authDomain: "trophy-mate.firebaseapp.com",
    projectId: "trophy-mate",
    storageBucket: "trophy-mate.firebasestorage.app",
    messagingSenderId: "1059017909817",
    appId: "1:1059017909817:web:85ce100685d75f94bccfe8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let unsubscribe = null;

  // DOM elements
  const authScreen = document.getElementById('authScreen');
  const appScreen = document.getElementById('appScreen');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const authError = document.getElementById('authError');
  const authSuccess = document.getElementById('authSuccess');
  const toggleAuth = document.getElementById('toggleAuth');
  const toggleText = document.getElementById('toggleText');
  const userEmailSpan = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const syncStatus = document.getElementById('syncStatus');

  let isSignupMode = false;

  // Toggle between login and signup
  toggleAuth.addEventListener('click', () => {
    isSignupMode = !isSignupMode;
    if (isSignupMode) {
      loginForm.style.display = 'none';
      signupForm.style.display = 'block';
      toggleText.textContent = 'Already have an account?';
      toggleAuth.textContent = 'Log in';
    } else {
      loginForm.style.display = 'block';
      signupForm.style.display = 'none';
      toggleText.textContent = "Don't have an account?";
      toggleAuth.textContent = 'Sign up';
    }
    hideMessages();
  });

  function showError(msg) {
    authError.textContent = msg;
    authError.classList.add('show');
    authSuccess.classList.remove('show');
  }

  function showSuccess(msg) {
    authSuccess.textContent = msg;
    authSuccess.classList.add('show');
    authError.classList.remove('show');
  }

  function hideMessages() {
    authError.classList.remove('show');
    authSuccess.classList.remove('show');
  }

  // Sign Up
  document.getElementById('signupBtn').addEventListener('click', async () => {
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (!email || !password) {
      showError('Please enter email and password');
      return;
    }

    if (password.length < 6) {
      showError('Password must be at least 6 characters');
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      // Initialize empty data for new user
      await setDoc(doc(db, 'users', userCredential.user.uid), {
        goals: [],
        actions: {},
        selectedGoalId: "",
        lastUpdated: Date.now()
      });
      showSuccess('Account created! Logging you in...');
    } catch (error) {
      showError(error.message);
    }
  });

  // Log In
  document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
      showError('Please enter email and password');
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      showSuccess('Logged in successfully!');
    } catch (error) {
      showError('Invalid email or password');
    }
  });

  // Log Out
  logoutBtn.addEventListener('click', async () => {
    if (confirm('Are you sure you want to log out?')) {
      await signOut(auth);
    }
  });

  // Auth State Observer
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      userEmailSpan.textContent = user.email;
      authScreen.style.display = 'none';
      appScreen.classList.add('show');
      
      // Load user data from Firestore
      await loadUserData(user.uid);
      
      // Listen for real-time updates
      startRealtimeSync(user.uid);
    } else {
      currentUser = null;
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
      authScreen.style.display = 'flex';
      appScreen.classList.remove('show');
    }
  });

  async function loadUserData(uid) {
    try {
      syncStatus.textContent = 'Loading...';
      syncStatus.className = 'syncStatus syncing';
      
      const docRef = doc(db, 'users', uid);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        state.goals = data.goals || [];
        state.actions = data.actions || {};
        state.selectedGoalId = data.selectedGoalId || "";
      } else {
        // New user - initialize with empty data
        state.goals = [];
        state.actions = {};
        state.selectedGoalId = "";
        await saveToFirestore();
      }
      
      render();
      syncStatus.textContent = 'Synced';
      syncStatus.className = 'syncStatus';
    } catch (error) {
      console.error('Error loading data:', error);
      syncStatus.textContent = 'Error loading';
      syncStatus.className = 'syncStatus error';
    }
  }

  function startRealtimeSync(uid) {
    const docRef = doc(db, 'users', uid);
    unsubscribe = onSnapshot(docRef, (doc) => {
      if (doc.exists()) {
        const data = doc.data();
        const serverTime = data.lastUpdated || 0;
        const localTime = state.lastUpdated || 0;
        
        // Only update if server data is newer
        if (serverTime > localTime) {
          state.goals = data.goals || [];
          state.actions = data.actions || {};
          state.selectedGoalId = data.selectedGoalId || "";
          state.lastUpdated = serverTime;
          render();
          syncStatus.textContent = 'Synced';
          syncStatus.className = 'syncStatus';
        }
      }
    }, (error) => {
      console.error('Realtime sync error:', error);
      syncStatus.textContent = 'Sync error';
      syncStatus.className = 'syncStatus error';
    });
  }

  async function saveToFirestore() {
    if (!currentUser) return;
    
    try {
      syncStatus.textContent = 'Saving...';
      syncStatus.className = 'syncStatus syncing';
      
      state.lastUpdated = Date.now();
      
      await setDoc(doc(db, 'users', currentUser.uid), {
        goals: state.goals,
        actions: state.actions,
        selectedGoalId: state.selectedGoalId,
        lastUpdated: state.lastUpdated
      });
      
      syncStatus.textContent = 'Synced';
      syncStatus.className = 'syncStatus';
    } catch (error) {
      console.error('Error saving:', error);
      syncStatus.textContent = 'Save failed';
      syncStatus.className = 'syncStatus error';
    }
  }

  // Replace saveState with Firestore save
  window.originalSaveState = saveToFirestore;

  /* =========================
     STATE & LOGIC (same as original, but saves to Firestore)
     ========================= */

  const TIER_ORDER = { bronze:1, silver:2, gold:3, platinum:4 };

  const state = {
    goals: [],
    actions: {},
    selectedGoalId: "",
    lastUpdated: 0
  };

  function saveState() {
    saveToFirestore();
  }

  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
  }

  function cap(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function iconSrc(tier) {
    const map = {
      bronze: "Bronze_Trophy.png",
      silver: "Silver_Trophy.png",
      gold: "Gold_Trophy.png",
      platinum: "Platinum_Trophy.png"
    };
    return map[tier] || map.bronze;
  }

  /* Goals */
  function addGoal(title, hint) {
    if (!title.trim()) return alert("Goal title required");
    const g = {
      id: uid(),
      title: title.trim(),
      hint: hint.trim(),
      trophies: []
    };
    state.goals.push(g);
    state.selectedGoalId = g.id;
    saveState();
    render();
    renderManageGoalSelect();
    renderManageGoalEdits();
    renderManageTrophyList();
  }

  function deleteGoal(gid) {
    const g = state.goals.find(x => x.id === gid);
    if (!g) return;
    const ok = confirm(`Delete goal "${g.title}" and all its trophies?`);
    if (!ok) return;
    state.goals = state.goals.filter(x => x.id !== gid);
    if (state.selectedGoalId === gid) {
      state.selectedGoalId = state.goals.length ? state.goals[0].id : "";
    }
    saveState();
    render();
    renderManageGoalSelect();
    renderManageGoalEdits();
    renderManageTrophyList();
  }

  function getSelectedGoal() {
    return state.goals.find(g => g.id === state.selectedGoalId) || state.goals[0];
  }

  function saveGoalEdits() {
    const g = getSelectedGoal();
    if (!g) return;
    const t = document.getElementById("mgEditTitle").value.trim();
    const h = document.getElementById("mgEditHint").value.trim();
    if (!t) return alert("Title required");
    g.title = t;
    g.hint = h;
    saveState();
    render();
    renderManageGoalSelect();
    renderManageGoalEdits();
  }

  /* Trophies */
  function addTrophyToSelectedGoal() {
    const g = getSelectedGoal();
    if (!g) return alert("Select or add a goal first");
    const title = document.getElementById("mgTrophyTitle").value.trim();
    const desc = document.getElementById("mgTrophyDesc").value.trim();
    const tier = document.getElementById("mgTrophyTier").value;
    const hidden = document.getElementById("mgTrophyHidden").value === "yes";
    const ruleType = document.getElementById("mgRuleType").value.trim();
    const ruleThresh = parseInt(document.getElementById("mgRuleThresh").value, 10);

    if (!title) return alert("Trophy title required");

    const tr = {
      id: uid(),
      title,
      desc,
      tier,
      hidden,
      unlocked: false,
      unlockMethod: null,
      unlockedAt: null,
      rule: null
    };

    if (ruleType && ruleThresh > 0 && tier !== "platinum") {
      tr.rule = { type: ruleType, threshold: ruleThresh };
    }

    g.trophies.push(tr);
    saveState();
    render();
    renderManageTrophyList();
    renderActionTypes();
    updatePlatWarning();

    document.getElementById("mgTrophyTitle").value = "";
    document.getElementById("mgTrophyDesc").value = "";
    document.getElementById("mgRuleType").value = "";
    document.getElementById("mgRuleThresh").value = "1";
  }

  function deleteTrophy(gid, tid) {
    const g = state.goals.find(x => x.id === gid);
    if (!g) return;
    const tr = g.trophies.find(t => t.id === tid);
    if (!tr) return;
    const ok = confirm(`Delete trophy "${tr.title}"?`);
    if (!ok) return;
    g.trophies = g.trophies.filter(t => t.id !== tid);
    saveState();
    render();
    renderManageTrophyList();
    renderActionTypes();
  }

  function editTrophy(gid, tid) {
    const g = state.goals.find(x => x.id === gid);
    if (!g) return;
    const tr = g.trophies.find(t => t.id === tid);
    if (!tr) return;

    const newTitle = prompt("Trophy title:", tr.title);
    if (!newTitle || !newTitle.trim()) return;
    const newDesc = prompt("Trophy description:", tr.desc);
    const newTier = prompt("Tier (bronze/silver/gold/platinum):", tr.tier);
    const newHidden = confirm("Hidden trophy?") ? "yes" : "no";

    tr.title = newTitle.trim();
    tr.desc = newDesc ? newDesc.trim() : "";
    if (["bronze", "silver", "gold", "platinum"].includes(newTier)) {
      tr.tier = newTier;
    }
    tr.hidden = newHidden === "yes";

    saveState();
    render();
    renderManageTrophyList();
  }

  function unlockTrophy(gid, tid, method) {
    const g = state.goals.find(x => x.id === gid);
    if (!g) return;
    const tr = g.trophies.find(t => t.id === tid);
    if (!tr) return;
    if (tr.unlocked) return;

    tr.unlocked = true;
    tr.unlockMethod = method;
    tr.unlockedAt = Date.now();

    const others = g.trophies.filter(t0 => t0.tier !== "platinum");
    const allUnlocked = others.every(t0 => t0.unlocked);
    if (allUnlocked) {
      const plat = g.trophies.find(t0 => t0.tier === "platinum");
      if (plat && !plat.unlocked) {
        plat.unlocked = true;
        plat.unlockMethod = "auto";
        plat.unlockedAt = Date.now();
      }
    }

    saveState();
  }

  function resetTrophy(gid, tid) {
    const g = state.goals.find(x => x.id === gid);
    if (!g) return;
    const tr = g.trophies.find(t => t.id === tid);
    if (!tr) return;

    tr.unlocked = false;
    tr.unlockMethod = null;
    tr.unlockedAt = null;

    const plat = g.trophies.find(t0 => t0.tier === "platinum");
    if (plat && plat.unlocked) {
      plat.unlocked = false;
      plat.unlockMethod = null;
      plat.unlockedAt = null;
    }

    saveState();
  }

  /* Actions */
  function logAction(actionType, count) {
    if (!actionType) return alert("Select an action type");
    if (!state.actions[actionType]) state.actions[actionType] = 0;
    state.actions[actionType] += count;
    saveState();
    runAutoUnlocks();
    render();
    if (manageOverlay.classList.contains("show")) {
      renderManageTrophyList();
      updatePlatWarning();
    }
  }

  function runAutoUnlocks() {
    let changed = false;
    for (const g of state.goals) {
      for (const tr of g.trophies) {
        if (tr.unlocked) continue;
        if (!tr.rule) continue;
        const count = state.actions[tr.rule.type] || 0;
        if (count >= tr.rule.threshold) {
          unlockTrophy(g.id, tr.id, "auto");
          changed = true;
        }
      }
    }
    if (changed) saveState();
  }

  /* Manage modal */
  const manageOverlay = document.getElementById("manageOverlay");
  const btnManage = document.getElementById("btnManage");
  const mgClose = document.getElementById("mgClose");
  const mgAddGoal = document.getElementById("mgAddGoal");
  const mgGoalTitle = document.getElementById("mgGoalTitle");
  const mgGoalHint = document.getElementById("mgGoalHint");
  const mgSelectGoal = document.getElementById("mgSelectGoal");
  const mgEditBox = document.getElementById("mgEditBox");
  const mgEditTitle = document.getElementById("mgEditTitle");
  const mgEditHint = document.getElementById("mgEditHint");
  const mgSaveGoalEdits = document.getElementById("mgSaveGoalEdits");
  const mgDeleteGoal = document.getElementById("mgDeleteGoal");
  const mgAddTrophy = document.getElementById("mgAddTrophy");
  const mgTrophyList = document.getElementById("mgTrophyList");
  const platWarning = document.getElementById("platWarning");
  const mgTrophyTier = document.getElementById("mgTrophyTier");
  const goalTable = document.getElementById("goalTable");
  const actionType = document.getElementById("actionType");
  const actionCount = document.getElementById("actionCount");
  const btnLog = document.getElementById("btnLog");

  function openManage() {
    manageOverlay.classList.add("show");
    renderManageGoalSelect();
    renderManageGoalEdits();
    renderManageTrophyList();
    updatePlatWarning();
  }

  function openManageForGoal(gid) {
    state.selectedGoalId = gid;
    saveState();
    openManage();
  }

  function closeManage() {
    manageOverlay.classList.remove("show");
  }

  function renderManageGoalSelect() {
    mgSelectGoal.innerHTML = "";
    if (!state.goals.length) {
      const opt = document.createElement("option");
      opt.textContent = "No goals yet";
      mgSelectGoal.appendChild(opt);
      mgEditBox.style.display = "none";
      return;
    }
    for (const g of state.goals) {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = g.title;
      mgSelectGoal.appendChild(opt);
    }
    if (state.selectedGoalId) {
      mgSelectGoal.value = state.selectedGoalId;
    } else {
      state.selectedGoalId = state.goals[0].id;
      mgSelectGoal.value = state.selectedGoalId;
    }
    mgEditBox.style.display = "block";
  }

  function renderManageGoalEdits() {
    const g = getSelectedGoal();
    if (!g) {
      mgEditBox.style.display = "none";
      return;
    }
    mgEditBox.style.display = "block";
    mgEditTitle.value = g.title;
    mgEditHint.value = g.hint;
  }

  function updatePlatWarning() {
    const tier = mgTrophyTier.value;
    if (tier === "platinum") {
      platWarning.classList.add("show");
    } else {
      platWarning.classList.remove("show");
    }
  }

  mgTrophyTier.addEventListener("change", updatePlatWarning);

  function renderManageTrophyList() {
    mgTrophyList.innerHTML = "";
    const g = getSelectedGoal();
    if (!g || !g.trophies.length) {
      mgTrophyList.innerHTML = `<div class="small">No trophies yet. Add one above!</div>`;
      return;
    }
    let sorted = g.trophies.slice();
    sorted.sort((a, b) => (TIER_ORDER[a.tier] - TIER_ORDER[b.tier]) || (a.title || "").localeCompare(b.title || ""));
    for (const tr of sorted) {
      const item = document.createElement("div");
      item.style.cssText = "padding:10px; background:rgba(0,0,0,.15); border:1px solid rgba(255,255,255,.10); border-radius:12px; margin-bottom:8px";
      item.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px">
          <div style="flex:1; min-width:0">
            <div style="font-weight:600; font-size:13px">${escapeHtml(tr.title)}</div>
            <div style="color:var(--muted); font-size:12px; margin-top:2px">${escapeHtml(tr.desc)}</div>
            <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap">
              <span class="badge">${cap(tr.tier)}</span>
              ${tr.hidden ? '<span class="badge">Hidden</span>' : ''}
              ${tr.rule ? `<span class="badge">Auto: ${tr.rule.type} ‚â• ${tr.rule.threshold}</span>` : ''}
            </div>
          </div>
          <button class="btn ghost" data-act="edit">Edit</button>
          <button class="btn danger" data-act="del">Delete</button>
        </div>
      `;
      item.querySelector('[data-act="edit"]').addEventListener("click", () => editTrophy(g.id, tr.id));
      item.querySelector('[data-act="del"]').addEventListener("click", () => deleteTrophy(g.id, tr.id));
      mgTrophyList.appendChild(item);
    }
  }

  function render() {
    renderGoalTable();
    renderActionTypes();
  }

  function renderGoalTable() {
    goalTable.innerHTML = "";

    for (const g of state.goals) {
      const total = g.trophies.length;
      const unlocked = g.trophies.filter(t0 => t0.unlocked).length;
      const pct = total ? Math.round((unlocked / total) * 100) : 0;

      const b = g.trophies.filter(t0 => t0.tier === "bronze").length;
      const s = g.trophies.filter(t0 => t0.tier === "silver").length;
      const gg = g.trophies.filter(t0 => t0.tier === "gold").length;
      const p = g.trophies.filter(t0 => t0.tier === "platinum").length;

      const best =
        g.trophies.some(t0 => t0.unlocked && t0.tier === "platinum") ? "platinum" :
          g.trophies.some(t0 => t0.unlocked && t0.tier === "gold") ? "gold" :
            g.trophies.some(t0 => t0.unlocked && t0.tier === "silver") ? "silver" :
              "bronze";

      let inner = g.trophies.slice();
      inner.sort((a, b2) => (TIER_ORDER[a.tier] - TIER_ORDER[b2.tier]) || (a.title || "").localeCompare(b2.title || ""));

      const game = document.createElement("div");
      game.className = "goalGame" + (state.selectedGoalId === g.id ? " open" : "");

      game.innerHTML = `
        <div class="goalGameHead" role="button" aria-expanded="${state.selectedGoalId === g.id ? "true" : "false"}" title="Click to expand. Double-click to edit trophies.">
          <div class="goalGameLeft">
            <div class="goalGameArt" aria-hidden="true"><img src="${iconSrc(best)}" alt="" /></div>
            <div class="goalGameMeta">
              <div class="goalGameName">${escapeHtml(g.title)}</div>
              <div class="goalGameHint">${escapeHtml(g.hint || "")}</div>
            </div>
          </div>

          <div class="goalCount b" title="Bronze trophies">${b}</div>
          <div class="goalCount s" title="Silver trophies">${s}</div>
          <div class="goalCount g" title="Gold trophies">${gg}</div>
          <div class="goalCount p" title="Platinum trophies">${p}</div>

          <div class="goalPct">
            <div class="badge">${pct}%</div>
            <div class="goalMiniBar"><div class="goalMiniFill" style="width:${pct}%"></div></div>
          </div>
        </div>

        <div class="goalGameBody">
          <div class="small"><b>${escapeHtml(g.title)} ‚Äî trophies</b></div>
          <div class="trophyList"></div>
        </div>
      `;

      const head = game.querySelector(".goalGameHead");
      let clickTimer = null;

      head.addEventListener("click", () => {
        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => {
          state.selectedGoalId = (state.selectedGoalId === g.id) ? "" : g.id;
          saveState();
          render();

          if (manageOverlay.classList.contains("show")) {
            renderManageGoalSelect();
            renderManageGoalEdits();
            renderManageTrophyList();
            updatePlatWarning();
          }
          clickTimer = null;
        }, 220);
      });

      head.addEventListener("dblclick", (e) => {
        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = null;
        e.preventDefault();
        openManageForGoal(g.id);
      });

      const innerWrap = game.querySelector(".trophyList");
      if (state.selectedGoalId === g.id && inner.length) {
        for (const tr of inner) {
          innerWrap.appendChild(renderTrophy(g, tr));
        }
      }

      goalTable.appendChild(game);
    }
  }

  function renderActionTypes() {
    const types = new Set();
    for (const g of state.goals) {
      for (const t0 of g.trophies) {
        if (t0.rule?.type) types.add(t0.rule.type);
      }
    }
    const list = Array.from(types).sort((a, b) => a.localeCompare(b));
    actionType.innerHTML = "";
    for (const tp of list) {
      const opt = document.createElement("option");
      opt.value = tp;
      opt.textContent = tp;
      actionType.appendChild(opt);
    }
    if (!actionType.value && list.length) actionType.value = list[0];
  }

  function renderTrophy(goal, trophy) {
    const el = document.createElement("div");
    el.className = "trophy" + (trophy.unlocked ? "" : " locked");

    const isHiddenLocked = trophy.hidden && !trophy.unlocked;
    const title = isHiddenLocked ? "Hidden trophy" : trophy.title;
    const desc = isHiddenLocked ? "Keep going ‚Äî this will reveal when you unlock it." : trophy.desc;

    const tags = [];
    if (trophy.rule) tags.push(`<span class="tag auto">Auto</span>`);
    if (trophy.hidden) tags.push(`<span class="tag hidden">Hidden</span>`);
    if (trophy.unlocked && trophy.unlockMethod === "manual") tags.push(`<span class="tag manual">Manual</span>`);
    if (trophy.unlocked && trophy.unlockedAt) {
      const date = new Date(trophy.unlockedAt);
      const formattedDate = date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      tags.push(`<span class="tag date">${formattedDate}</span>`);
    }

    const tierLabel = cap(trophy.tier);

    el.innerHTML = `
      <div class="icon" aria-hidden="true" title="${tierLabel}">
        <img class="trophyImg" src="${iconSrc(trophy.tier)}" alt="${tierLabel} trophy" />
      </div>
      <div class="tMain">
        <div class="tTitle">
          <span class="hiddenMask" title="${escapeAttr(title)}">${escapeHtml(title)}</span>
          <span class="badge">${tierLabel}</span>
        </div>
        <div class="tDesc">${escapeHtml(desc)}</div>
        <div class="tFoot">
          <div class="tTags">${tags.join("")}</div>
          <div class="toggle" title="Manually mark complete (or reset)">
            <div class="check ${trophy.unlocked ? "on" : ""}" role="switch" aria-checked="${trophy.unlocked ? "true" : "false"}"><div class="knob"></div></div>
          </div>
        </div>
      </div>
    `;

    el.querySelector(".check").addEventListener("click", () => {
      if (!trophy.unlocked) {
        unlockTrophy(goal.id, trophy.id, "manual");
      } else {
        const ok = confirm(`Reset "${trophy.title}" to locked? This will also reset the goal's Platinum trophy (if any).`);
        if (ok) resetTrophy(goal.id, trophy.id);
      }
      render();
      if (manageOverlay.classList.contains("show")) {
        renderManageTrophyList();
        updatePlatWarning();
      }
    });

    return el;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(str) {
    return String(str ?? "").replaceAll('"', "&quot;");
  }

  /* Events */
  btnManage.addEventListener("click", openManage);
  mgClose.addEventListener("click", closeManage);
  manageOverlay.addEventListener("click", (e) => { if (e.target === manageOverlay) closeManage(); });

  mgAddGoal.addEventListener("click", () => {
    addGoal(mgGoalTitle.value, mgGoalHint.value);
    mgGoalTitle.value = "";
    mgGoalHint.value = "";
  });

  mgSelectGoal.addEventListener("change", () => {
    state.selectedGoalId = mgSelectGoal.value;
    saveState();
    render();
    renderManageGoalSelect();
    renderManageGoalEdits();
    renderManageTrophyList();
    updatePlatWarning();
  });

  mgSaveGoalEdits.addEventListener("click", saveGoalEdits);
  mgDeleteGoal.addEventListener("click", () => deleteGoal(getSelectedGoal().id));
  mgAddTrophy.addEventListener("click", addTrophyToSelectedGoal);

  btnLog.addEventListener("click", () => {
    const type = actionType.value;
    const count = parseInt(actionCount.value, 10) || 1;
    logAction(type, count);
  });

  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (manageOverlay.classList.contains("show")) closeManage();
  });
</script>
</body>
</html>
